#!/bin/bash -e

<% require "shellwords" %>

RUN_DIR=/var/vcap/sys/run/bbs
LOG_DIR=/var/vcap/sys/log/bbs
CONF_DIR=/var/vcap/jobs/bbs/config

PIDFILE=$RUN_DIR/bbs.pid

export GOMAXPROCS=$(nproc)

# Work around for GOLANG 1.5.3 DNS bug
export GODEBUG=netdns=cgo

<% if p("diego.bbs.etcd.require_ssl") %>
etcd_sec_flags=" \
   -etcdCertFile=${CONF_DIR}/certs/etcd/client.crt \
   -etcdKeyFile=${CONF_DIR}/certs/etcd/client.key \
   -etcdCaFile=${CONF_DIR}/certs/etcd/ca.crt"
<% else %>
etcd_sec_flags=""
<% end %>

<% if p("diego.bbs.require_ssl") %>
  ad_url_scheme="https"
  bbs_sec_flags=" \
   -certFile=${CONF_DIR}/certs/server.crt \
   -keyFile=${CONF_DIR}/certs/server.key \
   -caFile=${CONF_DIR}/certs/ca.crt"
<% else %>
  ad_url_scheme="http"
  bbs_sec_flags=""
<% end %>

<% if p("diego.bbs.sql.require_ssl") %>
  sql_sec_flags=" \
   -sqlCACertFile=${CONF_DIR}/certs/sql/ca.crt"
<% else %>
  sql_sec_flags=""
<% end %>


etcd_flags=""
<% if p("diego.bbs.etcd.machines").size > 0 %>
  etcd_flags="
    ${etcd_sec_flags} \
  -etcdCluster=<%= p("diego.bbs.etcd.machines").map{|addr| "\"#{p("diego.bbs.etcd.require_ssl") ? "https" : "http"}://#{addr}:4001\""}.join(",")%> \
  <% if_p("diego.bbs.etcd.client_session_cache_size") do |value| %> \
    -etcdClientSessionCacheSize=<%= value %> \
  <% end %> \
  <% if_p("diego.bbs.etcd.max_idle_conns_per_host") do |value| %> \
    -etcdMaxIdleConnsPerHost=<%= value %> \
  <% end %> \
  "
<% end %>

rep_sec_flags=" \
   -repRequireTLS=<%= p("diego.bbs.rep.require_tls") %> \
   -repClientSessionCacheSize=<%= p("diego.bbs.rep.client_session_cache_size") %>"

<% if_p("diego.bbs.rep.ca_cert", "diego.bbs.rep.client_key", "diego.bbs.rep.client_cert") do %>
 rep_sec_flags="${rep_sec_flags} \
   -repClientCert=${CONF_DIR}/certs/rep/client.crt \
   -repClientKey=${CONF_DIR}/certs/rep/client.key \
   -repCACert=${CONF_DIR}/certs/rep/ca.crt"
<% end %>

<%
    def db_params
      ['username', 'password', 'host', 'port', 'schema'].map {|name| "diego.bbs.sql.db_#{name}"}
    end

    def param_exists? param
      p(param) != ""
    end

    def connection_string_from_db_params
      return "" unless db_params.any? {|p| param_exists?(p)}

      unless db_params.all? {|p| param_exists?(p)}
        raise "all of the following parameters must be specified #{db_params.join(",")}"
      end

      values = db_params.map {|param| p(param)}
      # Note: order of the params is important here, it has to be username, password, host, port, schema in that order
      driver = p("diego.bbs.sql.db_driver")
      case driver
      when 'mysql'
        sprintf "%s:%s@tcp(%s:%s)/%s", *values
      when 'postgres'
        sprintf "postgres://%s:%s@%s:%s/%s", *values
      else
        raise "unknown driver #{driver}"
      end
    end

    connection_string = p('diego.bbs.sql.db_connection_string')

    if connection_string != "" && connection_string_from_db_params != ""
       raise "You can only specify 'diego.bbs.sql.db_connection_string' or '#{db_params.join(",")}'"
    end

    if connection_string == ""
       connection_string = connection_string_from_db_params
    end
%>

/var/vcap/packages/bbs/bin/bbs ${etcd_flags} ${bbs_sec_flags} ${rep_sec_flags} ${sql_sec_flags} \
  -activeKeyLabel=<%= Shellwords.shellescape(p("diego.bbs.active_key_label")) %> \
  -advertiseURL=${ad_url_scheme}<%="://#{name.gsub('_', '-')}-#{spec.index}.#{p("diego.bbs.advertisement_base_hostname")}:#{p("diego.bbs.listen_addr").split(':')[1]}" %> \
  -auctioneerAddress=<%= p("diego.bbs.auctioneer.api_url") %> \
  -consulCluster=http://127.0.0.1:8500 \
  -debugAddr=<%= p("diego.bbs.debug_addr") %> \
  <% p("diego.bbs.encryption_keys").each do |encryption_key| %> \
    -encryptionKey=<%= Shellwords.shellescape("#{encryption_key["label"]}:#{encryption_key["passphrase"]}") %> \
  <% end %> \
  -dropsondePort=<%= p("diego.bbs.dropsonde_port") %> \
  -listenAddress=<%= p("diego.bbs.listen_addr") %> \
  -healthAddress=<%= p("diego.bbs.health_addr") %> \
  -logLevel=<%= p("diego.bbs.log_level") %> \
  <% if p("diego.bbs.enable_access_log") %> \
  -accessLogPath=$LOG_DIR/bbs.access.log \
  <% end %> \
  -requireSSL=<%= p("diego.bbs.require_ssl") %> \
  -convergeRepeatInterval=<%= "#{p("diego.bbs.convergence.repeat_interval_in_seconds")}s" %> \
  -kickTaskDuration=<%= "#{p("diego.bbs.convergence.kick_task_duration_in_seconds")}s" %> \
  -expireCompletedTaskDuration=<%= "#{p("diego.bbs.convergence.expire_completed_task_duration_in_seconds")}s" %> \
  -expirePendingTaskDuration=<%= "#{p("diego.bbs.convergence.expire_pending_task_duration_in_seconds")}s" %> \
  <% if_p("diego.bbs.desired_lrp_creation_timeout") do |value| %> \
    -desiredLRPCreationTimeout=<%= value %> \
  <% end %> \
  -databaseConnectionString=<%= Shellwords.shellescape(connection_string) %> \
  <% if_p("diego.bbs.sql.db_driver") do |value| %> \
    -databaseDriver='<%= value %>' \
  <% end %> \
  <% if_p("diego.bbs.sql.max_open_connections") do |value| %> \
    -maxDatabaseConnections=<%= value %> \
  <% end %> \
  2> >(tee -a $LOG_DIR/bbs.stderr.log | logger -p user.error -t vcap.bbs) \
  1> >(tee -a $LOG_DIR/bbs.stdout.log | logger -p user.info -t vcap.bbs) & echo $! > $PIDFILE
